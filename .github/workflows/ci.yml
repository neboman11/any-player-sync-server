name: CI

on:
    pull_request:
    push:
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    packages: write

jobs:
    lint-and-check:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Cargo fmt check
              run: cargo fmt --all -- --check

            - name: Cargo clippy
              run: cargo clippy --all-targets --all-features -- -D warnings

            - name: Cargo check
              run: cargo check --all-targets --all-features

    test:
        runs-on: ubuntu-latest
        needs: [lint-and-check]
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: any_player_sync
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U postgres -d any_player_sync"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        env:
            DB_HOST: 127.0.0.1
            DB_PORT: 5432
            DB_USER: postgres
            DB_PASSWORD: postgres
            DB_NAME: any_player_sync
            DB_SSLMODE: disable
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Run tests
              run: cargo test --all-features

    docker:
        runs-on: ubuntu-latest
        needs: [test]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GHCR
              if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract Docker metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and (conditionally) push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
